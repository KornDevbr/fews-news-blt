name: Deployment to Pantheon via BLT

on:
  push:
    branches:
      - git-artifact_tool_implementing-artifact

jobs:
  deployment_artifacts:
    name: "Deploy code to Pantheon via DrevOps Git Artifacts tool"
    timeout-minutes: 7
    runs-on: ubuntu-latest
    env:
      # Variables to connect to Pantheon.
      PANTHEON_ENVIRONMENT: ${{ vars.PANTHEON_ENVIRONMENT }}
      PANTHEON_EMAIL: ${{ secrets.PANTHEON_EMAIL }}
      PANTHEON_MACHINE_TOKEN: ${{ secrets.PANTHEON_MACHINE_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # Install PHP.
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      # Install Node for theme installation.
      - name: Node js installer
        uses: actions/setup-node@v3
        with:
          node-version: 16
          cache: 'npm'
          cache-dependency-path: web/themes/custom/fewsnews_theme/package-lock.json

      # Configuring private ssh key for code deployment to Pantheon.
      - name: Install SSH key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_KEY }}
          name: id_rsa
          known_hosts: ${{ secrets.KNOWN_HOSTS }}

      - name: Terminus installing
        run: |
          cd
          mkdir -p ~/terminus && cd ~/terminus
          curl -L https://github.com/pantheon-systems/terminus/releases/download/3.2.1/terminus.phar --output terminus
          chmod +x terminus
          ./terminus self:update
          sudo ln -s ~/terminus/terminus /usr/local/bin/terminus
          terminus auth:login --email=$PANTHEON_EMAIL --machine-token=$PANTHEON_MACHINE_TOKEN

      # Configuring SSH config to auto-adding not knowing fingerprints without asking.
      - name: Fingerprint configuring
        run: |
          sudo chmod o+w /etc/ssh/ssh_config
          echo "StrictHostKeyChecking accept-new" >> /etc/ssh/ssh_config

      - name: Build project
        run: |
          composer install
          cd web/themes/custom/fewsnews_theme/
          npm install && npm run build

      - name: Push artifacts to Pantheon
        env:
          PANTHEON_REMOTE: ${{ secrets.PANTHEON_REMOTE }}
        run: |
          robo artifact --branch=$GITHUB_REF_NAME --mode=branch --push $PANTHEON_REMOTE

      - name: Deploy changes to the Drupal website on Pantheon.
        run: |
          sleep 30
          terminus drush $PANTHEON_ENVIRONMENT deploy
